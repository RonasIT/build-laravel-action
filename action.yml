name: "Ronas IT: Run Laravel Test"
description: "This action runs laravel tests using docker-compose"
inputs:
  docker-compose-file-path:
    description: "Where docker-compose.yaml is located"
    required: true
    default: .${{ github.action_path }}/docker-compose.testing.yaml
runs:
  using: "composite"
  steps:
    - id: checkout
      name: Checkout repository
      uses: actions/checkout@v3
    - id: copy-env-testing-to-env
      name: Copy .env.testing to .env
      run: |
        cp .env.testing .env
      shell: bash
    - id: run-docker-compose-up
      name: Run docker-compose up
      run: |
        docker-compose up -d -f ${{ inputs.docker-compose-file-path }}
      shell: bash
    - id: prepare-containers
      name: Prepare containers for running tests
      run: |
        docker-compose exec -T nginx composer install -f ${{ inputs.docker-compose-file-path }}
        docker-compose exec -T nginx php artisan jwt:secret --env=testing -f ${{ inputs.docker-compose-file-path }}
        docker-compose exec -T nginx php artisan key:generate --env=testing -f ${{ inputs.docker-compose-file-path }}
      shell: bash
    - id: run-tests
      name: Run tests
      run: |
        docker-compose exec -T nginx php vendor/bin/phpunit --stop-on-failure ./tests/ -f ${{ inputs.docker-compose-file-path }}
      shell: bash
    - name: Show Logs
      if: ${{ failure() }}
      run: |
        docker-compose exec -T nginx cat storage/logs/*.log -f ${{ inputs.docker-compose-file-path }} || true
      shell: bash
